# 配置简化说明

## 改进概述

数据库配置已从 **6 个参数** 简化为 **3 个参数**，使配置更加简洁易用。

## 对比

### ❌ 旧版配置（复杂）

```yaml
source:
  host: "192.168.1.100"      # 主机地址
  port: 3306                 # 端口号
  username: "root"           # 用户名
  password: "password123"    # 密码
  database: "source_db"      # 数据库名
  charset: "utf8mb4"         # 字符集
```

**6 个参数**，配置繁琐，容易出错。

### ✅ 新版配置（简化）

```yaml
source:
  url: "192.168.1.100:3306/source_db"  # 数据库地址
  username: "root"                      # 用户名
  password: "password123"               # 密码
```

**3 个参数**，配置简洁，一目了然。

## 主要改进

### 1. URL 统一格式

将 `host`、`port`、`database` 三个参数合并为一个 `url` 参数。

**格式**: `host:port/database`

**示例**:
- `localhost:3306/mydb`
- `192.168.1.100:3306/production`
- `db.example.com:3306/app_db`

### 2. 自动字符集

不需要手动指定字符集，默认使用 `utf8mb4`，支持完整 Unicode。

### 3. 配置文件更短

完整配置文件从 47 行减少到约 30 行，减少 **36%** 的配置内容。

## 实际例子

### 场景 1: 本地开发

**旧版**:
```yaml
source:
  host: "localhost"
  port: 3306
  username: "root"
  password: "root"
  database: "dev_db"
  charset: "utf8mb4"
```

**新版**:
```yaml
source:
  url: "localhost:3306/dev_db"
  username: "root"
  password: "root"
```

**节省**: 3 行配置

### 场景 2: 远程生产环境

**旧版**:
```yaml
source:
  host: "production.example.com"
  port: 3306
  username: "sync_user"
  password: "complex_password_123"
  database: "production_db"
  charset: "utf8mb4"

target:
  host: "backup.example.com"
  port: 3306
  username: "backup_user"
  password: "backup_password_456"
  database: "backup_db"
  charset: "utf8mb4"
```

**新版**:
```yaml
source:
  url: "production.example.com:3306/production_db"
  username: "sync_user"
  password: "complex_password_123"

target:
  url: "backup.example.com:3306/backup_db"
  username: "backup_user"
  password: "backup_password_456"
```

**节省**: 6 行配置

### 场景 3: Docker 环境

**旧版**:
```yaml
source:
  host: "mysql-container-1"
  port: 3306
  username: "root"
  password: "mysql_root_password"
  database: "app_db"
  charset: "utf8mb4"
```

**新版**:
```yaml
source:
  url: "mysql-container-1:3306/app_db"
  username: "root"
  password: "mysql_root_password"
```

**节省**: 3 行配置

## 优势总结

| 特性 | 旧版 | 新版 | 改进 |
|------|------|------|------|
| 参数数量 | 6 个 | 3 个 | ✅ 减少 50% |
| 配置行数 | ~47 行 | ~30 行 | ✅ 减少 36% |
| 易用性 | 较复杂 | 简单 | ✅ 更易用 |
| 出错概率 | 较高 | 低 | ✅ 更可靠 |
| 可读性 | 一般 | 清晰 | ✅ 更直观 |
| 复制修改 | 繁琐 | 便捷 | ✅ 更高效 |

## 迁移指南

如果你已经在使用旧版配置，可以轻松迁移到新版：

### 迁移步骤

**旧配置**:
```yaml
source:
  host: "192.168.1.100"
  port: 3306
  username: "root"
  password: "password"
  database: "mydb"
  charset: "utf8mb4"
```

**转换为新配置**:
```yaml
source:
  url: "192.168.1.100:3306/mydb"  # 合并 host:port/database
  username: "root"                 # 保持不变
  password: "password"             # 保持不变
```

### 转换公式

```
url = host + ":" + port + "/" + database
```

### 批量转换示例

**原配置**:
```yaml
source:
  host: "10.0.1.50"
  port: 3306
  database: "sales_db"
  username: "admin"
  password: "admin123"

target:
  host: "10.0.1.60"
  port: 3306
  database: "sales_backup"
  username: "backup"
  password: "backup456"
```

**新配置**:
```yaml
source:
  url: "10.0.1.50:3306/sales_db"
  username: "admin"
  password: "admin123"

target:
  url: "10.0.1.60:3306/sales_backup"
  username: "backup"
  password: "backup456"
```

## 常见问题

### Q1: 为什么要简化配置？

**A**: 
- 减少配置复杂度
- 降低出错概率
- 提高配置效率
- 更符合直觉

### Q2: 旧配置文件还能用吗？

**A**: 不能。新版本只支持简化后的配置格式。请按照迁移指南更新配置文件。

### Q3: URL 格式是否灵活？

**A**: URL 必须严格遵循 `host:port/database` 格式：
- ✅ 正确: `localhost:3306/mydb`
- ❌ 错误: `localhost/mydb` (缺少端口)
- ❌ 错误: `localhost:3306` (缺少数据库名)

### Q4: 字符集如何修改？

**A**: 默认使用 `utf8mb4`。如需修改，请编辑源代码中的 `GetDSN()` 方法。

### Q5: 支持其他数据库吗？

**A**: 当前版本只支持 MySQL。未来版本计划支持 PostgreSQL、SQL Server 等。

## 实践建议

### 1. 使用环境变量

对于敏感信息，建议使用环境变量：

```bash
# Linux/Mac
export DB_SOURCE_URL="production.example.com:3306/app_db"
export DB_SOURCE_USER="root"
export DB_SOURCE_PASS="secret_password"

# Windows
set DB_SOURCE_URL=production.example.com:3306/app_db
set DB_SOURCE_USER=root
set DB_SOURCE_PASS=secret_password
```

然后在配置文件中引用（需要修改代码支持）。

### 2. 配置模板

创建配置模板，便于快速部署：

```yaml
# config.template.yaml
source:
  url: "${SOURCE_URL}"
  username: "${SOURCE_USER}"
  password: "${SOURCE_PASS}"

target:
  url: "${TARGET_URL}"
  username: "${TARGET_USER}"
  password: "${TARGET_PASS}"
```

### 3. 多环境配置

为不同环境创建不同的配置文件：

```
config.dev.yaml      # 开发环境
config.test.yaml     # 测试环境
config.prod.yaml     # 生产环境
```

使用时指定：
```bash
./db-sync -config config.prod.yaml
```

### 4. 配置检查

运行前检查配置是否正确：

```bash
# 检查配置文件语法
cat config.yaml

# 测试数据库连接
mysql -h 192.168.1.100 -P 3306 -u root -p -D mydb
```

## 技术细节

### DSN 生成过程

```go
// 配置
url:      "192.168.1.100:3306/mydb"
username: "root"
password: "password123"

// 内部生成 DSN
dsn := "root:password123@tcp(192.168.1.100:3306/mydb)?charset=utf8mb4&parseTime=True&loc=Local"
```

### 自动添加的参数

- `charset=utf8mb4`: 使用 UTF-8 字符集（4 字节）
- `parseTime=True`: 自动解析 DATE/DATETIME 类型
- `loc=Local`: 使用本地时区

## 示例配置集合

### 最小配置

```yaml
source:
  url: "localhost:3306/db1"
  username: "root"
  password: "root"

target:
  url: "localhost:3306/db2"
  username: "root"
  password: "root"

sync:
  batch_size: 200
```

### 推荐配置

```yaml
source:
  url: "192.168.1.100:3306/production_db"
  username: "readonly_user"
  password: "safe_password"

target:
  url: "192.168.1.200:3306/backup_db"
  username: "write_user"
  password: "write_password"

sync:
  batch_size: 200
  truncate_before_sync: true
  exclude_tables:
    - "tmp_*"
    - "temp_*"
  timeout: 3600
  verbose: true

log:
  level: "info"
  file: "sync.log"
  console: true
```

### 完整配置

```yaml
# 源数据库
source:
  url: "production.example.com:3306/app_db"
  username: "sync_user"
  password: "complex_password_123"

# 目标数据库
target:
  url: "backup.example.com:3306/app_db_backup"
  username: "backup_user"
  password: "backup_password_456"

# 同步配置
sync:
  batch_size: 200
  truncate_before_sync: true
  exclude_tables:
    - "tmp_*"
    - "temp_*"
    - "cache_*"
    - "session_*"
  include_tables: []
  timeout: 3600
  verbose: true

# 日志配置
log:
  level: "info"
  file: "sync.log"
  console: true
```

## 总结

配置简化后：

✅ **更简单** - 从 6 个参数减少到 3 个  
✅ **更清晰** - URL 格式一目了然  
✅ **更高效** - 减少配置时间和错误  
✅ **更专业** - 符合业界标准

立即升级到简化配置，享受更好的使用体验！

---

**文档版本**: 1.0  
**更新日期**: 2025-11-04  
**适用版本**: v1.0.0+

需要帮助？请查看 [使用说明-简化版.md](使用说明-简化版.md)

