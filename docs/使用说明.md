# MySQL 数据库同步工具 - 详细使用说明

## 目录

1. [工具简介](#工具简介)
2. [核心特性](#核心特性)
3. [安装部署](#安装部署)
4. [配置说明](#配置说明)
5. [使用方法](#使用方法)
6. [常见问题](#常见问题)
7. [最佳实践](#最佳实践)
8. [技术支持](#技术支持)

---

## 工具简介

本工具是一个基于 Go 语言开发的 MySQL 数据库全量同步工具，主要用于在两个 MySQL 数据库之间进行数据复制。工具采用模块化设计，支持批量传输以应对带宽限制，具有完善的日志记录和错误处理机制。

### 适用场景

- ✅ 生产环境到测试环境的数据同步
- ✅ 数据库迁移
- ✅ 数据备份和灾备
- ✅ 跨区域数据中心同步
- ✅ 数据库克隆

### 技术特点

- 使用 Go 语言开发，性能优秀
- 支持批量数据传输，可配置批量大小
- 自动创建表结构
- 实时显示同步进度和速度
- 完善的错误处理和日志记录
- 支持表过滤（包含/排除）
- 优雅退出机制

---

## 核心特性

### 1. 全量数据同步

工具能够自动发现源数据库中的所有表，并将数据完整复制到目标数据库。

**工作流程**:
1. 连接源数据库和目标数据库
2. 获取源数据库的所有表
3. 读取每个表的结构和数据
4. 在目标数据库创建相同结构的表
5. 批量复制数据

### 2. 批量传输

为了应对带宽限制，工具采用批量传输机制：

```yaml
sync:
  batch_size: 200  # 每次传输 200 条记录
```

**批量大小建议**:
- 低带宽（<1Mbps）: 50-100
- 中等带宽（1-10Mbps）: 200-500
- 高带宽（>10Mbps）: 1000-5000

### 3. 表过滤

支持灵活的表过滤机制：

**排除特定表**:
```yaml
sync:
  exclude_tables:
    - "tmp_*"      # 排除所有 tmp_ 开头的表
    - "temp_*"     # 排除所有 temp_ 开头的表
    - "logs"       # 排除 logs 表
```

**只同步特定表**:
```yaml
sync:
  include_tables:
    - "users"      # 只同步 users 表
    - "orders"     # 只同步 orders 表
```

### 4. 进度显示

实时显示同步进度：

```
表 users: 批次 25/50, 进度: 50.00% (5000/10000), 速度: 200 行/秒
```

显示信息包括：
- 当前批次 / 总批次
- 完成百分比
- 已同步行数 / 总行数
- 同步速度（行/秒）

### 5. 日志记录

支持多级别日志：

```yaml
log:
  level: "info"           # debug, info, warn, error
  file: "sync.log"        # 日志文件路径
  console: true           # 是否输出到控制台
```

日志内容包括：
- 连接信息
- 表发现信息
- 同步进度
- 错误信息
- 统计数据

---

## 安装部署

### 方式一：下载预编译版本

1. 从 GitHub Releases 下载对应平台的可执行文件
2. 解压到任意目录
3. 配置并运行

### 方式二：从源码编译

#### 前置要求

- Go 1.21 或更高版本
- Git

#### 编译步骤

**Windows**:
```cmd
# 克隆代码
git clone https://github.com/yourusername/db-sync-tools.git
cd db-sync-tools

# 下载依赖
go mod download

# 编译
go build -o db-sync.exe cmd/db-sync/main.go

# 或使用批处理脚本
build.bat
```

**Linux/Mac**:
```bash
# 克隆代码
git clone https://github.com/yourusername/db-sync-tools.git
cd db-sync-tools

# 下载依赖
go mod download

# 编译
go build -o db-sync cmd/db-sync/main.go

# 或使用 shell 脚本
chmod +x build.sh
./build.sh
```

---

## 配置说明

### 配置文件格式

配置文件采用 YAML 格式，包含四个主要部分：

1. source: 源数据库配置
2. target: 目标数据库配置
3. sync: 同步参数配置
4. log: 日志配置

### 完整配置示例

```yaml
# 源数据库配置（数据从这里读取）
source:
  host: "192.168.1.100"        # 数据库主机地址
  port: 3306                   # 数据库端口
  username: "root"             # 数据库用户名
  password: "password123"      # 数据库密码
  database: "source_db"        # 数据库名称
  charset: "utf8mb4"           # 字符集

# 目标数据库配置（数据写入这里）
target:
  host: "192.168.1.200"        # 数据库主机地址
  port: 3306                   # 数据库端口
  username: "root"             # 数据库用户名
  password: "password456"      # 数据库密码
  database: "target_db"        # 数据库名称
  charset: "utf8mb4"           # 字符集

# 同步配置
sync:
  # 每批次处理的记录数
  batch_size: 200
  
  # 是否在同步前清空目标表
  # true: 完全覆盖，清空后再写入
  # false: 追加模式，保留现有数据
  truncate_before_sync: false
  
  # 要排除的表（支持通配符 * 和 ?）
  exclude_tables:
    - "tmp_*"
    - "temp_*"
    - "cache_*"
  
  # 只同步这些表（如果为空则同步所有表）
  include_tables: []
  
  # 单表同步超时时间（秒）
  timeout: 3600
  
  # 是否显示详细日志
  verbose: true

# 日志配置
log:
  # 日志级别
  # debug: 最详细的调试信息
  # info: 一般信息（推荐）
  # warn: 警告信息
  # error: 只显示错误
  level: "info"
  
  # 日志文件路径（为空则不写入文件）
  file: "sync.log"
  
  # 是否输出到控制台
  console: true
```

### 配置参数详解

#### source / target (数据库配置)

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| host | string | 是 | 数据库主机地址，支持域名或 IP |
| port | int | 是 | 数据库端口，通常为 3306 |
| username | string | 是 | 数据库用户名 |
| password | string | 是 | 数据库密码 |
| database | string | 是 | 数据库名称 |
| charset | string | 否 | 字符集，默认 utf8mb4 |

#### sync (同步配置)

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| batch_size | int | 是 | 每批次记录数，建议 50-5000 |
| truncate_before_sync | bool | 否 | 是否清空目标表，默认 false |
| exclude_tables | []string | 否 | 排除的表，支持通配符 |
| include_tables | []string | 否 | 只同步这些表，为空则全部 |
| timeout | int | 否 | 超时时间（秒），默认 3600 |
| verbose | bool | 否 | 详细日志，默认 true |

#### log (日志配置)

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| level | string | 否 | 日志级别，默认 info |
| file | string | 否 | 日志文件路径，为空则不写文件 |
| console | bool | 否 | 是否输出到控制台，默认 true |

---

## 使用方法

### 基本使用流程

#### 1. 准备配置文件

```bash
# 复制示例配置
cp config.example.yaml config.yaml

# 编辑配置文件
vim config.yaml  # Linux/Mac
notepad config.yaml  # Windows
```

#### 2. 运行同步

```bash
# Windows
db-sync.exe -config config.yaml

# Linux/Mac
./db-sync -config config.yaml
```

#### 3. 查看日志

```bash
# Linux/Mac
tail -f sync.log

# Windows (PowerShell)
Get-Content sync.log -Wait -Tail 50
```

### 命令行参数

```bash
db-sync [选项]

选项:
  -config string
        配置文件路径 (默认 "config.yaml")
  -version
        显示版本信息
```

### 使用示例

#### 示例1: 基本同步

```bash
# 使用默认配置文件
./db-sync

# 等同于
./db-sync -config config.yaml
```

#### 示例2: 使用自定义配置

```bash
./db-sync -config /path/to/my-config.yaml
```

#### 示例3: 查看版本

```bash
./db-sync -version
```

输出:
```
MySQL Database Sync Tool v1.0.0
```

### 同步过程示例

完整的同步过程输出：

```
=================================
MySQL Database Sync Tool v1.0.0
=================================
2025-11-04 10:00:00 [INFO] 连接源数据库: root@192.168.1.100:3306/source_db
2025-11-04 10:00:01 [INFO] 源数据库连接成功
2025-11-04 10:00:01 [INFO] 连接目标数据库: root@192.168.1.200:3306/target_db
2025-11-04 10:00:02 [INFO] 目标数据库连接成功
2025-11-04 10:00:02 [INFO] 开始发现数据库表...
2025-11-04 10:00:02 [INFO] 发现 5 个需要同步的表
2025-11-04 10:00:02 [INFO] ==============================
2025-11-04 10:00:02 [INFO] 开始同步数据库
2025-11-04 10:00:02 [INFO] 源数据库: root@192.168.1.100:3306/source_db
2025-11-04 10:00:02 [INFO] 目标数据库: root@192.168.1.200:3306/target_db
2025-11-04 10:00:02 [INFO] 批量大小: 200
2025-11-04 10:00:02 [INFO] 总表数: 5
2025-11-04 10:00:02 [INFO] ==============================
2025-11-04 10:00:03 [INFO] 总数据行数: 25000
2025-11-04 10:00:03 [INFO] 正在同步第 1/5 个表...
2025-11-04 10:00:03 [INFO] 开始同步表: users (总行数: 10000)
2025-11-04 10:00:04 [INFO] 表 users: 批次 1/50, 进度: 2.00% (200/10000), 速度: 200 行/秒
2025-11-04 10:00:05 [INFO] 表 users: 批次 2/50, 进度: 4.00% (400/10000), 速度: 200 行/秒
...
2025-11-04 10:00:53 [INFO] 表 users 同步完成: 共同步 10000 行, 耗时 50s
2025-11-04 10:00:53 [INFO] 正在同步第 2/5 个表...
...
2025-11-04 10:05:00 [INFO] ==============================
2025-11-04 10:05:00 [INFO] 数据库同步完成!
2025-11-04 10:05:00 [INFO] 总表数: 5
2025-11-04 10:05:00 [INFO] 成功: 5
2025-11-04 10:05:00 [INFO] 失败: 0
2025-11-04 10:05:00 [INFO] 总行数: 25000
2025-11-04 10:05:00 [INFO] 同步行数: 25000
2025-11-04 10:05:00 [INFO] 总耗时: 4m58s
2025-11-04 10:05:00 [INFO] 平均速度: 84 行/秒
2025-11-04 10:05:00 [INFO] ==============================
2025-11-04 10:05:00 [INFO] 程序正常退出
```

---

## 常见问题

### 1. 连接问题

#### 问题: 无法连接到数据库

**错误信息**:
```
连接数据库失败: dial tcp 192.168.1.100:3306: connect: connection refused
```

**可能原因**:
- 数据库服务未运行
- IP 地址或端口错误
- 防火墙阻止连接
- 数据库未开启远程访问

**解决方法**:
1. 检查数据库服务状态
   ```bash
   # Linux
   systemctl status mysql
   
   # Windows
   服务管理器中查看 MySQL 服务
   ```

2. 测试端口连通性
   ```bash
   telnet 192.168.1.100 3306
   ```

3. 检查 MySQL 配置
   ```bash
   # 确保 bind-address 允许远程连接
   # /etc/mysql/my.cnf
   bind-address = 0.0.0.0
   ```

4. 检查防火墙
   ```bash
   # Linux
   firewall-cmd --add-port=3306/tcp --permanent
   firewall-cmd --reload
   ```

#### 问题: 认证失败

**错误信息**:
```
连接数据库失败: Error 1045: Access denied for user 'root'@'192.168.1.200'
```

**可能原因**:
- 用户名或密码错误
- 用户没有远程访问权限

**解决方法**:
```sql
-- 创建或更新用户权限
CREATE USER 'sync_user'@'%' IDENTIFIED BY 'password123';
GRANT SELECT, INSERT, CREATE, DROP ON *.* TO 'sync_user'@'%';
FLUSH PRIVILEGES;
```

### 2. 同步问题

#### 问题: 同步速度很慢

**可能原因**:
- batch_size 设置太小
- 网络带宽不足
- 数据库性能瓶颈

**解决方法**:
1. 增加批量大小
   ```yaml
   sync:
     batch_size: 1000  # 增大批量
   ```

2. 检查网络速度
   ```bash
   # 测试网络延迟
   ping 192.168.1.100
   ```

3. 优化数据库
   - 临时禁用索引
   - 增加 innodb_buffer_pool_size
   - 使用 SSD 硬盘

#### 问题: 主键冲突

**错误信息**:
```
写入数据失败: Error 1062: Duplicate entry '1' for key 'PRIMARY'
```

**可能原因**:
- 目标表已有数据
- truncate_before_sync 设置为 false

**解决方法**:
```yaml
sync:
  truncate_before_sync: true  # 清空目标表
```

或手动清空目标表：
```sql
TRUNCATE TABLE table_name;
```

#### 问题: 内存使用过高

**可能原因**:
- batch_size 设置太大
- 表中有大字段（BLOB, TEXT）

**解决方法**:
```yaml
sync:
  batch_size: 50  # 减小批量
```

### 3. 数据问题

#### 问题: 某些表同步失败

**查看失败详情**:
同步完成后会列出失败的表：
```
以下表同步失败:
  - large_table: 执行INSERT失败: Error 1153: Got a packet bigger than 'max_allowed_packet'
```

**解决方法**:
增加 MySQL 的 max_allowed_packet：
```sql
SET GLOBAL max_allowed_packet=1073741824;  -- 1GB
```

或在 my.cnf 中设置：
```ini
[mysqld]
max_allowed_packet=1G
```

#### 问题: 字符编码错误

**错误信息**:
```
Incorrect string value: '\xF0\x9F...'
```

**解决方法**:
确保使用 utf8mb4 字符集：
```yaml
source:
  charset: "utf8mb4"
target:
  charset: "utf8mb4"
```

---

## 最佳实践

### 1. 同步前准备

#### 数据库备份
```bash
# 备份目标数据库
mysqldump -h target_host -u root -p target_db > target_db_backup.sql
```

#### 检查磁盘空间
```bash
# Linux
df -h

# Windows
dir
```

#### 评估数据量
```sql
-- 查看数据库大小
SELECT 
    table_schema AS 'Database',
    SUM(data_length + index_length) / 1024 / 1024 AS 'Size (MB)'
FROM information_schema.tables
WHERE table_schema = 'your_database'
GROUP BY table_schema;
```

### 2. 批量大小选择

根据实际情况选择合适的批量大小：

| 网络带宽 | 数据特点 | 建议批量 |
|---------|---------|---------|
| < 1 Mbps | 普通表 | 50-100 |
| 1-10 Mbps | 普通表 | 200-500 |
| > 10 Mbps | 普通表 | 1000-5000 |
| 任何 | 含大字段 | 10-50 |
| 局域网 | 普通表 | 5000-10000 |

### 3. 执行时机

- ✅ 业务低峰期（如凌晨）
- ✅ 维护窗口期
- ✅ 测试环境随时可以
- ❌ 避免业务高峰期

### 4. 监控和验证

#### 实时监控
```bash
# 监控日志
tail -f sync.log | grep -E "进度|完成|失败"

# 监控数据库连接
mysql -e "SHOW PROCESSLIST;"
```

#### 同步后验证
```sql
-- 比较行数
SELECT 'source' AS db, COUNT(*) FROM source_db.table_name
UNION ALL
SELECT 'target' AS db, COUNT(*) FROM target_db.table_name;

-- 比较数据校验和
SELECT 'source' AS db, MD5(GROUP_CONCAT(id ORDER BY id)) 
FROM source_db.table_name
UNION ALL
SELECT 'target' AS db, MD5(GROUP_CONCAT(id ORDER BY id)) 
FROM target_db.table_name;
```

### 5. 定时任务

#### Linux Crontab
```bash
# 编辑定时任务
crontab -e

# 每天凌晨 2 点执行
0 2 * * * cd /opt/db-sync-tools && ./db-sync -config config.yaml >> /var/log/db-sync-cron.log 2>&1
```

#### Windows 任务计划程序
1. 打开"任务计划程序"
2. 创建基本任务
3. 设置触发器（每天 2:00）
4. 设置操作：运行程序
   - 程序：`C:\db-sync-tools\db-sync.exe`
   - 参数：`-config config.yaml`
   - 起始于：`C:\db-sync-tools`

### 6. 安全建议

#### 配置文件权限
```bash
# Linux
chmod 600 config.yaml
chown sync_user:sync_group config.yaml
```

#### 使用专用账户
```sql
-- 创建只读源账户
CREATE USER 'sync_reader'@'%' IDENTIFIED BY 'strong_password';
GRANT SELECT ON source_db.* TO 'sync_reader'@'%';

-- 创建写入目标账户
CREATE USER 'sync_writer'@'%' IDENTIFIED BY 'strong_password';
GRANT SELECT, INSERT, CREATE, DROP ON target_db.* TO 'sync_writer'@'%';

FLUSH PRIVILEGES;
```

#### 网络安全
- 使用 VPN 或专线连接
- 启用 SSL 连接
- 限制 IP 访问

---

## 技术支持

### 获取帮助

1. **查看文档**
   - [README.md](README.md) - 项目概述
   - [QUICKSTART.md](QUICKSTART.md) - 快速开始
   - [EXAMPLES.md](EXAMPLES.md) - 使用示例
   - [PROJECT_STRUCTURE.md](PROJECT_STRUCTURE.md) - 架构说明

2. **查看日志**
   ```bash
   # 查看最新日志
   tail -100 sync.log
   
   # 搜索错误
   grep ERROR sync.log
   ```

3. **提交 Issue**
   - GitHub: https://github.com/yourusername/db-sync-tools/issues
   - 请提供：
     - 配置文件（隐藏敏感信息）
     - 错误日志
     - 数据库版本
     - 操作系统版本

4. **社区支持**
   - 讨论区: https://github.com/yourusername/db-sync-tools/discussions
   - 邮件列表: sync-tools@example.com

### 常用命令速查

```bash
# 查看版本
./db-sync -version

# 运行同步
./db-sync -config config.yaml

# 查看实时日志
tail -f sync.log

# 搜索错误日志
grep -i error sync.log

# 统计同步行数
grep "同步完成" sync.log

# 查看同步耗时
grep "总耗时" sync.log
```

---

**最后更新**: 2025-11-04  
**版本**: 1.0.0  
**作者**: MySQL Sync Team

感谢使用 MySQL 数据库同步工具！

