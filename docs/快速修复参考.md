# 快速修复参考

## ✅ 已修复的问题

### 问题 1️⃣: DSN 格式错误
```
错误: invalid DSN: network address not terminated (missing closing brace)
```

**原因**: URL 格式 `host:port/database` 没有正确解析

**修复**: ✅ 已修复，自动分离 host:port 和 database

**测试**: 
```bash
# 重新编译
go build -o db-sync.exe cmd/db-sync/main.go

# 运行测试
db-sync.exe -config config.yaml
```

---

### 问题 2️⃣: MySQL 版本兼容性
```
错误: sql: expected 15 destination arguments in Scan, not 13
错误: sql: expected 4 destination arguments in Scan, not 2
```

**原因**: 不同 MySQL 版本返回的列数不同

**修复**: ✅ 使用动态列扫描，自动适配所有版本

**支持版本**:
- ✅ MySQL 5.5, 5.6, 5.7, 8.0
- ✅ MariaDB 10.x
- ✅ Percona Server

---

### 问题 3️⃣: 没有主键的表无法同步
```
警告: 获取表 xxx 的主键失败
错误: 获取表 xxx 的元数据失败
```

**原因**: 主键获取失败导致同步中断

**修复**: ✅ 主键失败只警告，继续同步

**结果**: 没有主键的表也能正常同步

---

### 问题 4️⃣: Ctrl+C 无法退出
```
症状: 按 Ctrl+C 后程序卡住，不退出
```

**原因**: 在获取元数据阶段没有检查取消信号

**修复**: ✅ 在关键循环中添加上下文检查

**结果**: Ctrl+C 后立即响应并优雅退出

---

## 🚀 使用步骤

### 1. 重新编译（必须）

```bash
go build -o db-sync.exe cmd/db-sync/main.go
```

### 2. 验证配置

```yaml
source:
  url: "host:port/database"  # ✅ 格式正确
  username: "root"
  password: "password"

target:
  url: "host:port/database"  # ✅ 格式正确
  username: "root"
  password: "password"

sync:
  batch_size: 200
```

### 3. 运行同步

```bash
db-sync.exe -config config.yaml
```

### 4. 测试 Ctrl+C

运行后按 `Ctrl+C`，应该立即退出并显示统计信息。

---

## 📋 快速检查清单

在运行前检查：

- [ ] 已重新编译程序
- [ ] 配置文件格式正确（url: "host:port/database"）
- [ ] 数据库连接正常
- [ ] 网络畅通

---

## 🔍 常见场景

### 场景 1: 本地测试

```yaml
source:
  url: "localhost:3306/test_db"
  username: "root"
  password: "root"

target:
  url: "localhost:3306/test_db_backup"
  username: "root"
  password: "root"

sync:
  batch_size: 100
```

### 场景 2: 远程同步

```yaml
source:
  url: "192.168.1.100:3306/production_db"
  username: "sync_user"
  password: "password123"

target:
  url: "192.168.1.200:3306/backup_db"
  username: "sync_user"
  password: "password456"

sync:
  batch_size: 200
```

### 场景 3: Cpolar 内网穿透

```yaml
source:
  url: "2.tcp.vip.cpolar.cn:10972/INSITE_changcheng"
  username: "root"
  password: "your_password"

target:
  url: "localhost:3306/local_db"
  username: "root"
  password: "local_password"

sync:
  batch_size: 200
```

---

## 💡 预期日志

### 正常运行

```
2025-11-04 10:00:00 [INFO] 连接源数据库: root@host:port/database
2025-11-04 10:00:01 [INFO] 源数据库连接成功
2025-11-04 10:00:01 [INFO] 连接目标数据库: root@host:port/database
2025-11-04 10:00:02 [INFO] 目标数据库连接成功
2025-11-04 10:00:02 [INFO] 开始发现数据库表...
```

### 表没有主键（正常）

```
2025-11-04 10:00:05 [WARN] 获取表 my_table 的主键失败: ...
2025-11-04 10:00:05 [INFO] 开始同步表: my_table (总行数: 1000)
2025-11-04 10:00:10 [INFO] 表 my_table 同步完成
```

### 建表SQL失败（自动生成）

```
2025-11-04 10:00:05 [WARN] 获取表 my_table 的建表SQL失败，将使用列信息自动生成
2025-11-04 10:00:05 [INFO] 开始同步表: my_table (总行数: 1000)
```

### Ctrl+C 退出

```
2025-11-04 10:00:10 [WARN] 收到信号: interrupt，正在优雅退出...
2025-11-04 10:00:10 [WARN] 收集元数据过程被取消
2025-11-04 10:00:10 [INFO] ==============================
2025-11-04 10:00:10 [INFO] 数据库同步完成!
2025-11-04 10:00:10 [INFO] 总表数: 50
2025-11-04 10:00:10 [INFO] 成功: 10
2025-11-04 10:00:10 [INFO] 失败: 0
```

---

## ⚠️ 故障排除

### Q: 仍然报 DSN 错误？

A: 确保已重新编译：
```bash
rm db-sync.exe
go build -o db-sync.exe cmd/db-sync/main.go
```

### Q: 仍然报列数不匹配？

A: 确保使用最新代码：
```bash
git pull  # 如果是从 git 获取的
go build -o db-sync.exe cmd/db-sync/main.go
```

### Q: Ctrl+C 仍然卡住？

A: 可能正在执行大批量操作，等待当前批次完成。或减小 batch_size：
```yaml
sync:
  batch_size: 50  # 减小批量
```

### Q: 表结构不完整？

A: 如果 SHOW CREATE TABLE 失败，会自动生成基本结构。可以手动创建表：
```sql
-- 在目标数据库手动创建表
CREATE TABLE ... ;
```

---

## 📞 获取帮助

如果问题仍未解决：

1. 查看日志文件：`sync.log`
2. 查看详细文档：`修复说明-v1.0.2.md`
3. 提交 Issue：https://github.com/yourusername/db-sync-tools/issues

提交问题时请包含：
- 完整错误信息
- 配置文件（隐藏密码）
- MySQL 版本
- 操作系统版本

---

## 📊 版本信息

| 版本 | 发布日期 | 主要修复 |
|------|---------|---------|
| v1.0.0 | 2025-11-04 | 初始版本 |
| v1.0.1 | 2025-11-04 | DSN格式修复 |
| v1.0.2 | 2025-11-04 | MySQL兼容性、无主键表支持、Ctrl+C改进 |

**当前版本**: v1.0.2  
**状态**: ✅ 稳定版

---

## ✨ 新功能

- ✅ 支持所有 MySQL 版本
- ✅ 支持无主键的表
- ✅ Ctrl+C 立即响应
- ✅ 自动生成建表SQL（后备方案）
- ✅ 详细的警告和错误提示

---

## 🎯 最佳实践

1. **测试环境先试**
   ```bash
   db-sync.exe -config config-test.yaml
   ```

2. **小批量开始**
   ```yaml
   sync:
     batch_size: 50  # 先用小批量测试
   ```

3. **监控日志**
   ```bash
   tail -f sync.log  # Linux/Mac
   Get-Content sync.log -Wait  # Windows PowerShell
   ```

4. **备份数据**
   ```bash
   mysqldump -u root -p target_db > backup.sql
   ```

---

**更新日期**: 2025-11-04  
**文档版本**: 1.0

一切准备就绪，可以开始同步了！ 🚀

